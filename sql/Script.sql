-- ==========================================
-- NETTOYAGE (Pour pouvoir relancer le script)
-- ==========================================
BEGIN
   EXECUTE IMMEDIATE 'DROP TABLE DOMMAGE CASCADE CONSTRAINTS';
EXCEPTION
   WHEN OTHERS THEN NULL;
END;
/

BEGIN
   EXECUTE IMMEDIATE 'DROP TABLE PAUSE CASCADE CONSTRAINTS';
EXCEPTION
   WHEN OTHERS THEN NULL;
END;
/

BEGIN
   EXECUTE IMMEDIATE 'DROP TABLE CHEMIN CASCADE CONSTRAINTS';
EXCEPTION
   WHEN OTHERS THEN NULL;
END;
/

BEGIN
   EXECUTE IMMEDIATE 'DROP TABLE POINT CASCADE CONSTRAINTS';
EXCEPTION
   WHEN OTHERS THEN NULL;
END;
/

BEGIN
   EXECUTE IMMEDIATE 'DROP SEQUENCE SEQ_DOMMAGE';
EXCEPTION
   WHEN OTHERS THEN NULL;
END;
/

-- Ajout du nettoyage pour la séquence PAUSE
BEGIN
   EXECUTE IMMEDIATE 'DROP SEQUENCE SEQ_PAUSE';
EXCEPTION
   WHEN OTHERS THEN NULL;
END;
/

BEGIN
   EXECUTE IMMEDIATE 'DROP SEQUENCE SEQ_CHEMIN';
EXCEPTION
   WHEN OTHERS THEN NULL;
END;
/

BEGIN
   EXECUTE IMMEDIATE 'DROP SEQUENCE SEQ_POINT';
EXCEPTION
   WHEN OTHERS THEN NULL;
END;
/

-- ==========================================
-- CREATION DES SEQUENCES
-- ==========================================
CREATE SEQUENCE SEQ_POINT START WITH 1 INCREMENT BY 1 NOCACHE;
CREATE SEQUENCE SEQ_CHEMIN START WITH 1 INCREMENT BY 1 NOCACHE;
CREATE SEQUENCE SEQ_DOMMAGE START WITH 1 INCREMENT BY 1 NOCACHE;
CREATE SEQUENCE SEQ_PAUSE START WITH 1 INCREMENT BY 1 NOCACHE;

-- ==========================================
-- CREATION DES TABLES
-- ==========================================

-- Table des Lieux
CREATE TABLE POINT (
    id NUMBER PRIMARY KEY,
    nom VARCHAR2(100) NOT NULL
);

-- Table des Chemins (Routes)
CREATE TABLE CHEMIN (
    id NUMBER PRIMARY KEY,
    nom VARCHAR2(100) NOT NULL,
    point_debut_id NUMBER NOT NULL REFERENCES POINT(id),
    point_fin_id NUMBER NOT NULL REFERENCES POINT(id),
    distance_km NUMBER(10, 2) NOT NULL,
    largeur_m NUMBER(5, 2) NOT NULL,
    sens VARCHAR2(20) NOT NULL CHECK (sens IN ('SIMPLE', 'DOUBLE'))
);

-- Table des Dommages
CREATE TABLE DOMMAGE (
    id NUMBER PRIMARY KEY,
    chemin_id NUMBER NOT NULL REFERENCES CHEMIN(id),
    debut_km NUMBER(10, 2) NOT NULL,
    fin_km NUMBER(10, 2) NOT NULL,
    reduction_taux NUMBER(5, 2) NOT NULL,
    CHECK (debut_km < fin_km)
);

-- Table des Pauses
CREATE TABLE PAUSE (
    id NUMBER PRIMARY KEY,
    chemin_id NUMBER NOT NULL REFERENCES CHEMIN(id),
    point_km NUMBER(10, 2) NOT NULL,
    heure_debut DATE NOT NULL,  -- Changé ici
    heure_fin DATE NOT NULL,    -- Changé ici
    CHECK (heure_debut < heure_fin) -- La comparaison marche encore très bien !
);

-- ======================================================
-- INSERTION DES DONNEES
-- ======================================================

-- Points
DELETE FROM POINT;
INSERT INTO POINT (id, nom) VALUES (1, 'Tananarive');
INSERT INTO POINT (id, nom) VALUES (2, 'Sambaina');
INSERT INTO POINT (id, nom) VALUES (3, 'Antsirabe');
INSERT INTO POINT (id, nom) VALUES (4, 'Ampefy');
DROP SEQUENCE SEQ_POINT;
CREATE SEQUENCE SEQ_POINT START WITH 5 INCREMENT BY 1 NOCACHE;

-- Chemins
DELETE FROM CHEMIN;
INSERT INTO CHEMIN VALUES (1, 'Tana-Sambaina', 1, 2, 200, 10, 'DOUBLE');
INSERT INTO CHEMIN VALUES (2, 'Sambaina-Antsirabe', 2, 3, 120, 10, 'DOUBLE');
INSERT INTO CHEMIN VALUES (3, 'Tana-Ampefy', 1, 4, 163, 10, 'DOUBLE');
INSERT INTO CHEMIN VALUES (4, 'Ampefy-Sambaina', 4, 2, 88, 10, 'DOUBLE');
DROP SEQUENCE SEQ_CHEMIN;
CREATE SEQUENCE SEQ_CHEMIN START WITH 5 INCREMENT BY 1 NOCACHE;

-- Dommages
DELETE FROM DOMMAGE;

-- 1 dommage
INSERT INTO DOMMAGE VALUES (1, 1, 30, 77, 0.22);
INSERT INTO DOMMAGE VALUES (2, 2, 12, 25, 0.66);
INSERT INTO DOMMAGE VALUES (3, 2, 56, 70, 0.11);
INSERT INTO DOMMAGE VALUES (4, 4, 25, 32, 0.15);

-- INSERT INTO DOMMAGE VALUES (2, 4, 50, 80, 0.25);

DROP SEQUENCE SEQ_DOMMAGE;
CREATE SEQUENCE SEQ_DOMMAGE START WITH 5 INCREMENT BY 1 NOCACHE;

-- Pauses
-- DELETE FROM PAUSE;

-- Format : 'HH24:MI' signifie Heures (0-23) et Minutes
-- INSERT INTO PAUSE VALUES (1, 1, 100, TO_DATE('08:15', 'HH24:MI'), TO_DATE('09:30', 'HH24:MI')); 
-- INSERT INTO PAUSE VALUES (2, 2, 60, TO_DATE('12:00', 'HH24:MI'), TO_DATE('13:00', 'HH24:MI')); 

-- DROP SEQUENCE SEQ_PAUSE;
-- CREATE SEQUENCE SEQ_PAUSE START WITH 3 INCREMENT BY 1 NOCACHE;

COMMIT;