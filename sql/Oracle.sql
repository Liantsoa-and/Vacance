-- ==========================================
-- NETTOYAGE (Pour pouvoir relancer le script)
-- ==========================================
BEGIN
   EXECUTE IMMEDIATE 'DROP TABLE DOMMAGE CASCADE CONSTRAINTS';
EXCEPTION
   WHEN OTHERS THEN NULL;
END;
/

BEGIN
   EXECUTE IMMEDIATE 'DROP TABLE PAUSE CASCADE CONSTRAINTS';
EXCEPTION
   WHEN OTHERS THEN NULL;
END;
/

BEGIN
   EXECUTE IMMEDIATE 'DROP TABLE CHEMIN CASCADE CONSTRAINTS';
EXCEPTION
   WHEN OTHERS THEN NULL;
END;
/

BEGIN
   EXECUTE IMMEDIATE 'DROP TABLE POINT CASCADE CONSTRAINTS';
EXCEPTION
   WHEN OTHERS THEN NULL;
END;
/

BEGIN
   EXECUTE IMMEDIATE 'DROP SEQUENCE SEQ_DOMMAGE';
EXCEPTION
   WHEN OTHERS THEN NULL;
END;
/

BEGIN
   EXECUTE IMMEDIATE 'DROP SEQUENCE SEQ_PAUSE';
EXCEPTION
   WHEN OTHERS THEN NULL;
END;
/

BEGIN
   EXECUTE IMMEDIATE 'DROP SEQUENCE SEQ_CHEMIN';
EXCEPTION
   WHEN OTHERS THEN NULL;
END;
/

BEGIN
   EXECUTE IMMEDIATE 'DROP SEQUENCE SEQ_POINT';
EXCEPTION
   WHEN OTHERS THEN NULL;
END;
/

-- ==========================================
-- CREATION DES SEQUENCES
-- ==========================================
CREATE SEQUENCE SEQ_POINT START WITH 1 INCREMENT BY 1 NOCACHE;
CREATE SEQUENCE SEQ_CHEMIN START WITH 1 INCREMENT BY 1 NOCACHE;
CREATE SEQUENCE SEQ_PAUSE START WITH 1 INCREMENT BY 1 NOCACHE;
CREATE SEQUENCE SEQ_DOMMAGE START WITH 1 INCREMENT BY 1 NOCACHE;

-- ==========================================
-- CREATION DES TABLES (VERSION CORRIGEE)
-- ==========================================

-- Table des Lieux
CREATE TABLE POINT (
    id NUMBER PRIMARY KEY,
    nom VARCHAR2(100) NOT NULL
);

-- Table des Chemins (Routes)
-- Les contraintes FK sont mises directement sur les colonnes pour éviter les erreurs de parsing
CREATE TABLE CHEMIN (
    id NUMBER PRIMARY KEY,
    nom VARCHAR2(100) NOT NULL,
    point_debut_id NUMBER NOT NULL REFERENCES POINT(id),
    point_fin_id NUMBER NOT NULL REFERENCES POINT(id),
    distance_km NUMBER(10, 2) NOT NULL,
    largeur_m NUMBER(5, 2) NOT NULL,
    sens VARCHAR2(20) NOT NULL CHECK (sens IN ('SIMPLE', 'DOUBLE'))
);

-- Table des Pauses
CREATE TABLE PAUSE (
    id NUMBER PRIMARY KEY,
    chemin_id NUMBER NOT NULL REFERENCES CHEMIN(id),
    point_km NUMBER(10, 2) NOT NULL,
    heure_debut TIMESTAMP NOT NULL,
    heure_fin TIMESTAMP NOT NULL,
    CHECK (heure_debut < heure_fin)
);

-- Table des Dommages
CREATE TABLE DOMMAGE (
    id NUMBER PRIMARY KEY,
    chemin_id NUMBER NOT NULL REFERENCES CHEMIN(id),
    debut_km NUMBER(10, 2) NOT NULL,
    fin_km NUMBER(10, 2) NOT NULL,
    reduction_taux NUMBER(5, 2) NOT NULL,
    CHECK (debut_km < fin_km)
);


-- ======================================================
-- INSERTION DES POINTS
-- ======================================================
DELETE FROM POINT;

INSERT INTO POINT (id, nom) VALUES (1, 'Paris');
INSERT INTO POINT (id, nom) VALUES (2, 'Lyon');
INSERT INTO POINT (id, nom) VALUES (3, 'Dijon');
INSERT INTO POINT (id, nom) VALUES (4, 'Nice');
INSERT INTO POINT (id, nom) VALUES (5, 'Marseille');
INSERT INTO POINT (id, nom) VALUES (6, 'Toulouse');
INSERT INTO POINT (id, nom) VALUES (7, 'Bordeaux');
INSERT INTO POINT (id, nom) VALUES (8, 'Nantes');
INSERT INTO POINT (id, nom) VALUES (9, 'Lille');
INSERT INTO POINT (id, nom) VALUES (10, 'Strasbourg');
INSERT INTO POINT (id, nom) VALUES (11, 'Montpellier');
INSERT INTO POINT (id, nom) VALUES (12, 'Reims');

DROP SEQUENCE SEQ_POINT;
CREATE SEQUENCE SEQ_POINT START WITH 13 INCREMENT BY 1 NOCACHE;

-- ======================================================
-- INSERTION DES CHEMINS (20 entrées)
-- ======================================================
DELETE FROM CHEMIN;

INSERT INTO CHEMIN VALUES (1, 'A6', 1, 2, 460, 7, 'DOUBLE');
INSERT INTO CHEMIN VALUES (2, 'A31', 1, 3, 310, 6, 'DOUBLE');
INSERT INTO CHEMIN VALUES (3, 'A7', 2, 5, 300, 7, 'DOUBLE');
INSERT INTO CHEMIN VALUES (4, 'A8', 5, 4, 220, 7, 'DOUBLE');
INSERT INTO CHEMIN VALUES (5, 'A9', 5, 11, 160, 7, 'DOUBLE');
INSERT INTO CHEMIN VALUES (6, 'A61', 11, 6, 240, 6, 'DOUBLE');
INSERT INTO CHEMIN VALUES (7, 'A62', 6, 7, 250, 7, 'DOUBLE');
INSERT INTO CHEMIN VALUES (8, 'A63', 7, 8, 300, 7, 'DOUBLE');
INSERT INTO CHEMIN VALUES (9, 'A10', 8, 1, 380, 7, 'DOUBLE');
INSERT INTO CHEMIN VALUES (10, 'A1', 1, 9, 200, 7, 'DOUBLE');
INSERT INTO CHEMIN VALUES (11, 'A26', 9, 12, 130, 6, 'DOUBLE');
INSERT INTO CHEMIN VALUES (12, 'A4', 12, 10, 200, 7, 'DOUBLE');
INSERT INTO CHEMIN VALUES (13, 'A36', 3, 10, 230, 6, 'DOUBLE');
INSERT INTO CHEMIN VALUES (14, 'Route RN7', 2, 11, 330, 3.5, 'SIMPLE');
INSERT INTO CHEMIN VALUES (15, 'Route RN20', 11, 6, 180, 3.5, 'SIMPLE');
INSERT INTO CHEMIN VALUES (16, 'Route RN83', 10, 4, 660, 4, 'SIMPLE');
INSERT INTO CHEMIN VALUES (17, 'Route Ouest', 8, 7, 140, 3.8, 'DOUBLE');
INSERT INTO CHEMIN VALUES (18, 'Route Est', 3, 12, 190, 4, 'DOUBLE');
INSERT INTO CHEMIN VALUES (19, 'Route Nord', 9, 1, 200, 3.2, 'SIMPLE');
INSERT INTO CHEMIN VALUES (20, 'Route Sud', 6, 5, 180, 3.2, 'SIMPLE');

DROP SEQUENCE SEQ_CHEMIN;
CREATE SEQUENCE SEQ_CHEMIN START WITH 21 INCREMENT BY 1 NOCACHE;

-- ======================================================
-- INSERTION DES PAUSES
-- ======================================================
DELETE FROM PAUSE;

INSERT INTO PAUSE VALUES (1, 1, 150, TO_TIMESTAMP('2024-01-13 10:30:00', 'YYYY-MM-DD HH24:MI:SS'), TO_TIMESTAMP('2024-01-13 10:45:00', 'YYYY-MM-DD HH24:MI:SS'));
INSERT INTO PAUSE VALUES (2, 1, 300, TO_TIMESTAMP('2024-01-13 14:00:00', 'YYYY-MM-DD HH24:MI:SS'), TO_TIMESTAMP('2024-01-13 14:30:00', 'YYYY-MM-DD HH24:MI:SS'));
INSERT INTO PAUSE VALUES (3, 3, 120, TO_TIMESTAMP('2024-01-13 12:00:00', 'YYYY-MM-DD HH24:MI:SS'), TO_TIMESTAMP('2024-01-13 13:00:00', 'YYYY-MM-DD HH24:MI:SS'));
INSERT INTO PAUSE VALUES (4, 6, 50, TO_TIMESTAMP('2024-01-13 09:30:00', 'YYYY-MM-DD HH24:MI:SS'), TO_TIMESTAMP('2024-01-13 09:45:00', 'YYYY-MM-DD HH24:MI:SS'));

DROP SEQUENCE SEQ_PAUSE;
CREATE SEQUENCE SEQ_PAUSE START WITH 5 INCREMENT BY 1 NOCACHE;

-- ======================================================
-- INSERTION DES DOMMAGES (plusieurs par chemin)
-- ======================================================
DELETE FROM DOMMAGE;

-- 1 dommage
INSERT INTO DOMMAGE VALUES (1, 1, 100, 150, 0.40);

-- 2 dommages sur le même chemin
INSERT INTO DOMMAGE VALUES (2, 3, 50, 100, 0.25);
INSERT INTO DOMMAGE VALUES (3, 3, 150, 200, 0.30);

-- 2 dommages sur A61
INSERT INTO DOMMAGE VALUES (4, 6, 10, 50, 0.20);
INSERT INTO DOMMAGE VALUES (5, 6, 120, 200, 0.50);

-- 1 dommage sur A62
INSERT INTO DOMMAGE VALUES (6, 7, 90, 140, 0.10);

-- 2 dommages sur A63
INSERT INTO DOMMAGE VALUES (7, 8, 150, 200, 0.15);
INSERT INTO DOMMAGE VALUES (8, 8, 220, 260, 0.25);

-- 1 dommage sur A4
INSERT INTO DOMMAGE VALUES (9, 12, 80, 120, 0.30);

-- 3 dommages sur RN83 (long trajet)
INSERT INTO DOMMAGE VALUES (10, 16, 50, 120, 0.10);
INSERT INTO DOMMAGE VALUES (11, 16, 200, 260, 0.25);
INSERT INTO DOMMAGE VALUES (12, 16, 400, 500, 0.40);

DROP SEQUENCE SEQ_DOMMAGE;
CREATE SEQUENCE SEQ_DOMMAGE START WITH 13 INCREMENT BY 1 NOCACHE;


COMMIT;
